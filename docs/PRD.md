# PRD: Bitbucket PR Description Generator - 瀏覽器擴充功能 (獨立版)

## 1. 概述

本產品是一個獨立的瀏覽器擴充功能（Browser
Extension），旨在將強大的 AI 能力直接嵌入開發者的 Bitbucket 工作流程中。它允許使用者在 Bitbucket 的 Pull
Request
(PR) 頁面內，一鍵生成高品質、結構化的 PR 描述。本擴充功能將處理從 Bitbucket 認證、使用者設定到與大型語言模型 (LLM) 互動的所有環節，提供一個完全無縫、無需離開當前頁面的高效解決方案。其目標是成為開發者處理 PR 事務時不可或缺的生產力工具。

## 2. 目標

- **提供自給自足的解決方案**：打造一個無需依賴任何外部網頁應用的、完整的獨立產品。
- **實現零上下文切換**：讓使用者在 Bitbucket
  PR 頁面內完成所有操作，從認證、設定到生成描述。
- **確保安全與穩健**：透過專屬後端服務處理敏感資料和複雜運算，確保使用者憑證安全和功能穩定。
- **最大化開發者效率**：將繁瑣的 PR 描述撰寫工作流簡化為「一鍵生成」，顯著節省時間。

## 3. 功能需求

### 3.1 核心功能

1.  **獨立的認證流程**：

    - 擴充功能將使用瀏覽器原生身份驗證 API（如
      `chrome.identity.launchWebAuthFlow`）來處理 Bitbucket 的 OAuth 2.0 流程。
    - 首次使用或 token 過期時，會自動彈出 Bitbucket 授權視窗，使用者完成授權後，認證 token 將被安全地儲存在擴充功能的儲存空間中，並傳遞給後端服務。

2.  **專屬設定頁面 (Options Page)**：

    - 擴充功能必須提供一個完整的設定頁面，使用者可以透過右鍵點擊擴充功能圖示 ->「選項」來訪問。
    - 此頁面是所有使用者配置的唯一入口，包含：
      - **帳戶管理**：顯示當前登錄的 Bitbucket 用戶資訊，並提供「登出」按鈕。
      - **LLM 提供商設定**：允許使用者選擇 LLM 提供商（xAI, OpenAI, Anthropic,
        Ollama）並輸入對應的 API 金鑰。金鑰輸入後將被發送到後端進行驗證和使用，**不會**儲存在瀏覽器本地。
      - **Ollama 端點設定**：為 Ollama 使用者提供輸入其本地服務 URL 的欄位。
      - **自訂模板管理**：提供一個編輯器，讓使用者可以創建、編輯、命名和刪除自己的 PR 描述模板。
      - **檔案忽略列表**：讓使用者可以配置在分析 diff 時需要忽略的檔案類型或路徑模式。

3.  **情境感知的使用者介面**：

    - **Popup
      UI**：點擊瀏覽器工具列上的擴充功能圖示，彈出主控制面板。包含模板和模型選擇器、生成按鈕及結果預覽區。
    - **嵌入式按鈕 (In-Page UI)**：在 Bitbucket
      PR 頁面的描述框附近動態注入一個「✨ AI 生成描述」按鈕，作為快捷觸發點。

4.  **自動化資料獲取與處理**：

    - 觸發生成時，內容腳本（Content
      Script）會自動從當前頁面解析 PR 所需的資訊（ID, Workspace, Repo）。
    - 這些資訊連同使用者的設定，會被發送到**專屬後端服務**。
    - 後端服務負責：
      1.  使用收到的 Bitbucket token 調用 Bitbucket API 獲取 PR 詳情和 diff。
      2.  對大型 diff 執行**分塊與摘要 (Map-Reduce)** 的前處理。
      3.  使用使用者選擇的 LLM 和對應的 API 金鑰，生成描述。

5.  **描述填充功能**：
    - 生成完成後，結果會返回到前端 Popup 預覽區。
    - 使用者可點擊「複製」或「填入頁面」，將描述無縫插入到 Bitbucket 的描述框中。

## 4. 非功能需求

- **效能**：擴充功能對瀏覽器性能的影響必須降至最低，頁面腳本注入和運行不得引起卡頓。
- **安全性**：
  - **後端職責**：所有對外部 API（Bitbucket,
    LLMs）的調用都必須透過後端代理。後端負責安全儲存 Bitbucket App 的 Client
    Secret，並以非持久化的方式處理使用者的 LLM API 金鑰。
  - **最小權限**：擴充功能僅請求運行所必需的最小權限（`identity`, `storage`,
    `activeTab`, `https://bitbucket.org/*`）。
- **穩定性**：應對 Bitbucket 前端 DOM 結構變化的能力至關重要。需採用穩定的選擇器，並設計優雅的失敗處理機制。
- **可維護性**：前後端代碼結構需清晰，便於獨立開發、測試和部署。

## 5. 使用者流程

1.  使用者從瀏覽器商店安裝擴充功能。
2.  使用者導航到任一 Bitbucket PR 頁面，點擊擴充功能圖示。
3.  介面提示「請登錄 Bitbucket」。點擊後，觸發 Bitbucket OAuth 彈窗。
4.  使用者完成授權，彈窗關閉。
5.  介面提示「請設定您的 LLM」。點擊「前往設定」，打開擴充功能的選項頁面。
6.  在選項頁面，使用者輸入他們選擇的 LLM 提供商的 API 金鑰，並可選擇性地創建一個自訂模板。儲存設定。
7.  使用者回到 PR 頁面，再次點擊擴充功能圖示（或頁面內嵌按鈕）。
8.  選擇模板和模型後，點擊「生成描述」。
9.  擴充功能將請求發送到後端，後端處理後返回結果。
10. 使用者預覽結果，點擊「填入頁面」，完成描述撰寫。

## 6. 技術棧與架構

- **擴充功能前端**：

  - **框架**：原生 JavaScript 或輕量級框架（如 Svelte, Vue）。
  - **核心元件**：Popup Script, Content Script, Background Script, Options
    Page。
  - **儲存**：使用 `chrome.storage.sync`
    來儲存使用者設定（如自訂模板、檔案忽略列表），以便跨裝置同步。**API 金鑰絕不儲存於此**。

- **專屬後端**：
  - **框架**：Node.js + Express。
  - **職責**：
    1.  **認證**：處理 Bitbucket OAuth 回調，驗證 code 並換取 token。
    2.  **安全代理**：作為所有外部 API 請求的唯一出口，保護使用者憑證和 API 金鑰。
    3.  **核心業務邏輯**：執行大型 diff 的 Map-Reduce 處理。
  - **部署**：AWS ECS, Vercel Functions, 或其他 Serverless/Container 平台。

### 架構圖

```
[User on Bitbucket PR Page] <--> [Content Script (DOM Read/Write)]
        |
        v
[Browser Action (Popup UI)] --> [Background Script] --> [Dedicated Backend API]
        ^                                                       |
        | (Settings, Templates)                                 |  +---------------------------+
[chrome.storage.sync] <------ [Options Page]                    |  | 1. Calls Bitbucket API    |
                                                                |  | 2. Processes Diff         |
                                                                +->| 3. Calls LLM API          |
                                                                   +---------------------------+
```

## 7. 風險與挑戰

- **後端開發與維護成本**：作為一個獨立產品，必須承擔後端服務的開發、部署、擴展和維護成本。
- **DOM 結構的脆弱性**：高度依賴 Bitbucket 的前端結構，任何變動都可能導致功能失效，需要快速的應變和更新機制。
- **瀏覽器商店審核**：發布和更新需通過審核，可能帶來時間延遲。對 `identity`
  權限的請求和對外部後端的通訊需要有充分合理的解釋。
- **複雜的首次使用者體驗**：使用者需要完成認證和設定兩個步驟才能開始使用，需要非常清晰的 UI/UX 引導來降低流失率。

## 8. 未來擴展

- **團隊方案**：推出團隊版，由管理員統一配置 API 金鑰和預設模板，團隊成員共享。
- **多平台支援**：將擴充功能擴展到 GitHub 和 GitLab。
- **進階分析**：在後端對 diff 進行更深入的靜態分析，例如識別出潛在的 bug 或不符合規範的程式碼，並在描述中提示。

## 9. 結論

將此產品定位為一個獨立的瀏覽器擴充功能，雖然增加了後端開發和維護的複雜性，但卻是提供最安全、最無縫、功能最完整體驗的唯一途徑。它直接將強大的 AI 工具嵌入到開發者的原生工作環境中，消除了所有不必要的操作步驟。這種深度整合的方案擁有巨大的潛力，能夠真正改變開發者的工作模式，建立起強大的產品競爭力和使用者忠誠度。
